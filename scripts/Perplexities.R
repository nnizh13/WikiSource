require(ggplot2) # install.packages("ggplot2")
library(dplyr)
require(data.table) # install.packages("data.table")

russian <- data.frame("perplexity"=c(97.9611, 50.4725, 618.584, 127.304, 222.553, 571.911, 558.268, 295.723, 442.205, 127.121, 387.362, 112.945, 98.3267, 139.241, 427.646, 157.039, 1859.78, 186.425, 372.478, 192.587, 177.265, 259.454, 159.371, 161.581, 412.571, 172.121, 164.35, 402.088, 584.247, 134.995, 303.087, 72.5324, 1620.04, 715.533, 488.346, 1015.13, 681.896, 660.008, 436.15, 416.371, 969.601, 1497.53, 232.056, 739.073, 597.506, 157.952, 756.79, 888.109, 205.134, 148.119, 2601.06, 382.335, 52.8998, 49.6541, 657.574, 567.507, 209.473, 1651.84, 531.916, 190.946, 281.593, 168.09, 433.372, 260.586, 577.268, 910.461, 169.789, 705.756, 752.956, 492.051, 501.064, 760.228, 88.6425, 28.2198, 108.083, 758.937, 550.487, 386.01, 817.541, 382.795, 408.213, 421.125, 309.32, 1120.33, 864.582, 845.728, 1345.33, 582.102, 1307.19, 422.071, 1635.01, 1137.91, 430.627, 1543.71, 1000.59, 377.076, 175.815, 2320.52, 647.441, 823.497, 664.783, 506.614, 564.061, 371.62, 464.585, 549.63, 95.5997, 421.718),
                         "years"=seq(1820L, 1927L, by = 1L))

italian <- data.frame("perplexity"=c(444.697, 1102.62, 1715.72, 862.693, 693.282, 966.839, 336.654, 775.697, 771.258, 366.918, 397.843, 947.688, 761.473, 816.41, 738.365, 493.465, 1055.14, 798.158, 869.444, 787.353, 943.908, 1083.72, 765.284, 848.449, 799.714, 813.116, 869.184, 807.224, 827.581, 377.222, 759.685, 412.666, 1005.15, 1299.64, 296.061, 1121.89, 789.972, 1130.18, 735.416, 743.028, 918.292, 703.898, 884.042, 1070.34, 876.277, 877.925, 821.697, 1081.22, 923.622, 932.197, 902.883, 773.157, 961.019, 1095.56, 714.456, 840.093, 1049.99, 1056.68, 823.514, 948.142, 978.858, 972.901, 839.926, 1189.31, 977.491, 690.717, 1104.38, 1033.17, 1055.47, 1198.75, 1232.29, 1121.19, 1022.75, 1088.68, 1129.92, 1175.71, 1346.57, 1138.65, 1131.47, 1093.83, 1110.32, 1337.32, 1173.41, 1108.72, 1233.45, 1209.23, 1205.46, 1341.6, 1270.24, 1168.35, 1636.68, 1510.83, 1406.89, 1513.26, 1324.83, 1097.14, 829.233, 1059.13, 910.24, 1019.15, 1214.4, 1099.22, 1107.85, 762.708, 912.58, 1004.41, 927.347, 1208.28, 1019.88),
                      "years"=seq(1820L, 1928L, by = 1L))

spanish <- data.frame("perplexity"=c(446.502, 454.147, 454.351, 527.283, 617.748, 506.751, 522.3, 420.299, 473.589, 441.708, 376.714, 461.817, 520.699, 536.209, 478.234, 482.449, 496.757, 352.061, 136.054, 422.809, 536.457, 511.453, 500.735, 545.949, 561.748, 550.188, 165.881, 236.796, 408.404, 176.931, 170.073, 329.897, 203.179, 216.886, 287.493, 179.376, 348.019, 205.08, 299.554, 229.761, 277.665, 267.701, 435.337, 118.214, 199.681, 282.787, 258.758, 176.811, 393.046, 449.982, 308.895, 310.107, 430.051, 314.732, 330.126, 367.435, 384.129, 367.821, 307.792, 376.649, 368.977, 296.083, 366.162, 649.205, 197.042, 448.643, 399.317, 287.084, 295.68, 275.961, 259.843, 337.859, 374.799, 475.449, 359.877, 259.501, 415.203, 356.219, 562.241, 315.623, 475.629, 439.32, 227.703, 414.063, 426.78, 325.303, 448.526, 365.5, 508.651, 733.07, 501.94, 395.214, 261.387, 372.39, 342.066, 301.448, 364.508, 490.36, 376.32, 460.974, 439.557, 518.546, 294.131, 136.03, 190.191, 205.334, 160.102, 81.529, 172.323, 187.752),
                      "years"=seq(1820L, 1929L, by = 1L))

english <- data.frame("perplexity"=c(601.293, 780.972, 265.269, 509.874, 199.466, 567.681, 710.212, 438.184, 647.727, 513.302, 790.117, 462.449, 391.39, 508.12, 760.822, 588.666, 454.616, 363.596, 618.878, 430.532, 445.228, 476.046, 540.777, 478.987, 533.39, 501.85, 811.708, 507.154, 638.585, 673.952, 646.903, 580.439, 598.591, 472.404, 478.517, 664.863, 617.262, 628.887, 633.289, 638.803, 772.888, 1011.47, 628.887, 689.189, 630.81, 587.865, 620.49, 721.776, 664.2, 618.801, 697.23, 645.573, 762.03, 774.25, 758.454, 766.571, 809.615, 752.432, 814.885, 799.568, 805.714, 806.795, 763.615, 821.738, 787.964, 786.892, 751.254, 797.176, 778.963, 807.855, 787.595, 755.878, 804.732, 860.788, 762.894, 765.156, 806.72, 867.534, 824.257, 830.775, 811.882, 774.863, 769.557, 825.616, 811.996, 797.963, 824.443, 855.366, 872.876, 886.969, 863.687, 981.147, 810.816, 1004.48, 1058.56, 799.187, 892.011, 930.367, 915.104, 837.573, 847.867, 854.203, 913.323, 1071.21, 655.376, 638.331, 489.448, 517.784, 462.726, 495.373),
                      "years"=seq(1820L, 1929L, by = 1L))

french <- data.frame("perplexity"=c(742.541, 701.455, 683.83, 720.25, 695.042, 787.364, 523.858, 397.596, 395.862, 615.947, 721.088, 824.809, 725.253, 803.964, 813.596, 704.412, 803.368, 808.069, 924.138, 811.697, 802.73, 808.907, 814.355, 751.75, 793.885, 788.752, 821.65, 795.305, 764.977, 810.075, 808.882, 776.071, 792.578, 826.59, 797.627, 882.021, 853.15, 828.121, 925.649, 814.353, 820.276, 826.613, 848.554, 849.43, 820.848, 796.065, 880.027, 810.586, 833.277, 837.695, 794.349, 773.635, 827.543, 857.338, 875.812, 818.11, 861.27, 899.926, 800.971, 807.511, 949.533, 790.182, 850.009, 895.935, 886.638, 898.062, 1006.71, 819.055, 905.455, 926.287, 941.242, 844.821, 814.326, 906.711, 896.179, 852.123, 942.72, 891.851, 914.428, 846.863, 919.323, 865.612, 919.63, 929.056, 957.373, 852.905, 826.626, 934.976, 903.106, 931.193, 939.809, 1099.7, 919.315, 1011.77, 853.817, 794.485, 835.334, 814.707, 870.796, 991.518, 874.915, 1012.91, 1091.58, 910.626, 1079.79, 1069.14, 872.936, 1054.47, 921.473, 836.933),
                     "years"=seq(1820L, 1929L, by = 1L))

chinese <- data.frame("perplexity"=c(30.5, 38.4006, 30.7693, 30.8656, 27.4107, 36.6761, 29.7857, 27.8524, 41.4842, 30.1913, 29.7693, 27.5, 28.8333, 27.7823, 44.9183, 30.4872, 24.25, 28.5, 27.944, 28.3334, 27.334, 30.2066, 30.7088, 31.8139, 427.325, 25.6666, 29.0909, 32.9952, 25.3875, 17.1804, 28.1666, 30.9992, 28.5, 190.428, 28.0091, 153.576, 31.3698, 30.41, 21.5, 30.6279, 22.0032, 29.5, 29.3636, 30.9205, 29.3333, 31.0988, 30.6154, 27.6724, 29.5266, 30.9545, 53.5651, 24.9495, 30.6154, 270.288, 29.6671, 30.1996, 142.888, 26.2857, 32.5692, 37.1332, 30.7188, 30.4956, 30.8052, 27.473, 42.6043, 43.6848, 32.4737, 30.6019, 41.2031, 48.4573, 34.863, 166.64, 45.3916, 85.9959, 30.6834, 62.0955, 588.856, 31.1763, 33.6081, 41.4734, 30.7747, 41.351, 208.144),
                     "years"=seq(1820L, 1902L, by = 1L))

russian = data.table(russian)
russian$Language = "Russian"

italian = data.table(italian)
italian$Language = "Italian"

spanish = data.table(spanish)
spanish$Language = "Spanish"

english = data.table(english)
english$Language = "English"

french = data.table(french)
french$Language = "French"

chinese = data.table(chinese)
chinese$Language = "Chinese"

data = rbindlist(list(russian, italian, spanish, english, french, chinese))
setnames(data, c("Perplexity", "Year", "Language"))


# Save data
fwrite(data, "ppl_ngram_year.csv")

# Remove some outliers
ru_mean = mean(data[Language=="Russian", Perplexity]) # 552.4155
ru_sd = sd(data[Language=="Russian", Perplexity]) # 476.827
nrow(data[Language=="Russian" & Perplexity > ru_mean + 2 * ru_sd])

data1 = rbindlist(list(
    data[Language != "Russian"],
    data[Language=="Russian" & Perplexity <= ru_mean + 2 * ru_sd]
))


p <- ggplot(data1, aes(x=Year, y=Perplexity))+
  geom_point(aes(color=Language, shape=Language)) +
  geom_smooth(method="lm", aes(color=Language, linetype=Language, fill=Language)) +
  theme_bw()


pdf("ppl(ngram)_year_pruned.pdf", 6, 5)
plot(p)
dev.off()


# Use linear models to check if the temporal patterns are significant
data = fread("ppl_ngram_year.csv")

m1 = lm(Perplexity ~ Year, data[Language=="Russian"])
summary(m1)
# Estimate Std. Error t value Pr(>|t|)
# (Intercept) -6953.970   2673.011  -2.602  0.01061 *
# Year            4.007      1.427   2.809  0.00593 **
# Adjusted R-squared:  0.06048

m2 = lm(Perplexity ~ Year, data[Language=="Italian"])
summary(m2)
# Estimate Std. Error t value Pr(>|t|)
# (Intercept) -7368.8501  1262.8798  -5.835 5.81e-08 ***
# Year            4.4493     0.6738   6.603 1.60e-09 ***
# Adjusted R-squared:  0.2829
